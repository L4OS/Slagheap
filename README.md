# stash
Selection of some interesting examples for the Everest processor

## Slagheap SoC

В этом репозитории вы найдёте библиотеки, тесты и примеры програм для компьютера "Террикон", также известного как Slagheap SoC. Изначально "компьютер" был реализовано на плате ["Марсоход"]    (ttps://marsohod.org/)https://marsohod.org/). Slagheap SOC был достаточно простым компьютером, он не задействовал микросхему DRAM и общался с внешним миром через UART порт. 
Главной особенностью этого компьютера была оригинальная система команд архитектуры CISC ([Complex Instruction Set Computer](https://habr.com/ru/companies/selectel/articles/542074/)).
Архитектура в шутку названная была названа "Эверест", как бы в противовес "Эльбрусам". Система команд Everest отличается высокой плотностью кода и оптимизирована для потокового исполнения.

![Everest instruction codes map](https://everest.l4os.ru/wp-content/uploads/2015/02/MAP_EVER_1_1.png)

Система команд Эверест обладает высоким потенциалом расширения - на карте показаны незадействованные коды операций.

## Пример функции (подрограммы) на языке "макроассемблер Эверест"

Пример ассемблерного кода для "Террикона". Функция выводит строку в последовательный порт.
Использована простая запись без именования регистров и констант.
<code>
; --- Функция вывода строки
; Вход: R1 - адрес строки
; Выход: R0 - количество переданных символов

function	_puts
	push	r15
	push	r2
	mov	r0, r1		; Копирование указателя на строку
load_word:
	mov	r2, (r0)	; Загрузка машинного слова (4-символа)
	load	r4, 4		; Количество байт в машинном слове
check_byte:
	rol	r2, 8		; Циклический сдвиг на 8 бит влево
	load	r3, 0xff	; Загрузка восьмибитной константы
	and	r3, r2		; Проверка на конец строки
	je	done		; Вывод строки закончен
	call	_putchar        ; Вызов подпрограммы вывода символа
	inc	r0, 1		; Инкремент указателя
	dec	r4, 1		; Декремент счётчика
	jne	check_byte	; Следующий символ
	jmp	load_word	; Повтор операции
done:
	clc			; Сброс переноса
	subc	r0, r1		; Подсчёт количества выведенных символов
	pop	r2
	pop	r15
	return			; Возврат из функции
end
</code>

Это пример не самой простой функции. Сложность заключается в разрядности операций. Процессорное ядро Эверест и система команд на момент публикации не имеет инструкций для операций с 8-ми и 16-ти быитными регистрами, поэтому их отсутствие приходится компенсировать сдвигами и масками.

## Виртуальный компьютер "Террикон"

В процессе отладки SoC была реализована программная модель микропроцессора. В процессе тестирования программная модель приросла виртуальным видеоадаптером и клавиатурой в дополнение к виртуальному алфавитно-цифровому терминал. Технические характеристики виртуального компьютера "Террикон": 
- 32 бита;
- 16 регистров регистров общего назначения;
- 64 регистра  регистра сообщений;
- 32 килобайта оперативной памяти, может быть увеличена до 2 гигабайт;
- консоль-терминал, может быть использована для отладки;
- видеоадаптер 640х480 с цветностью 32 бита на пиксель;
- виртуальная клавиатура;
- счётчик тактов хоста;
- виртуальная CMOS память 16 регистров.

<!-- позиционно независимый код который не привязанн к конкретным адресам -->

## Application binary interface (ABI)

